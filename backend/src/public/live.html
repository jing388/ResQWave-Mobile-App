<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Live Report</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
      body { font-family: Arial, sans-serif; margin: 16px; }
      .row { margin-bottom: 8px; }
      table { border-collapse: collapse; width: 100%; margin-top: 12px; }
      th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; }
      th { background: #f5f5f5; text-align: left; }
      #status { margin-left: 8px; color: #555; }
      code { background: #f2f2f2; padding: 2px 4px; }
    </style>
  </head>
  <body>
    <h2>Live Report (Realtime)</h2>
    <div class="row">
      <label>JWT Token:</label>
      <input id="token" type="text" size="80" placeholder="Paste Admin/Dispatcher JWT here" />
      <button id="connectBtn">Connect</button>
      <span id="status"></span>
    </div>

    <table>
      <thead>
        <tr>
          <th>Terminal ID</th>
          <th>Alert ID</th>
          <th>Community Group</th>
          <th>Alert Type</th>
          <th>Status</th>
          <th>Last Signal Time</th>
          <th>Address</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <script>
    const statusEl = document.getElementById("status");
    const rowsEl = document.getElementById("rows");
    const tokenEl = document.getElementById("token");
    const connectBtn = document.getElementById("connectBtn");

    let socket;

    function addRow(a) {
      const tr = document.createElement("tr");
      tr.setAttribute("data-alert-id", a.alertId || a.id); // ✅ store alertId in row for easy update
      tr.innerHTML = `
        <td>${a.terminalId || ""}</td>
        <td>${a.alertId || a.id || ""}</td>
        <td>${a.communityGroupName || ""}</td>
        <td>${a.alertType || ""}</td>
        <td class="status-cell">${a.status || ""}</td>
        <td>${a.lastSignalTime ? new Date(a.lastSignalTime).toLocaleString() : ""}</td>
        <td>${a.address || ""}</td>
      `;
      // newest on top
      rowsEl.insertBefore(tr, rowsEl.firstChild);
    }

    // ✅ update existing row instead of adding new one
    function updateRowStatus(alertID, newStatus) {
      const row = rowsEl.querySelector(`tr[data-alert-id="${alertID}"]`);
      if (row) {
        const statusCell = row.querySelector(".status-cell");
        if (statusCell) statusCell.textContent = newStatus;
      } else {
        console.warn("Row not found for alertID:", alertID);
      }
    }

    connectBtn.onclick = () => {
      const token = tokenEl.value.trim();
      if (!token) {
        alert("Please paste a JWT token first.");
        return;
      }
      if (socket) socket.disconnect();

      socket = io("/", { auth: { token } });

      socket.on("connect", () => {
        fetch("/alerts", {
          headers: { Authorization: `Bearer ${token}` },
        })
          .then((res) => res.json())
          .then((alerts) => {
            rowsEl.innerHTML = ""; // clear table before refill
            alerts.forEach(addRow);
          });
      });

      socket.on("connect_error", (e) => {
        statusEl.textContent = "Connect error: " + e.message;
        statusEl.style.color = "red";
      });

      socket.on("liveReport:new", (data) => addRow(data));
      socket.on("alert:new", (data) => addRow(data));

      // ✅ Listen for realtime status updates
      socket.on("alertStatusUpdated", (data) => {
        console.log("Realtime status update received:", data);
        updateRowStatus(data.alertID, data.newStatus);
      });
    };
  </script>

  </body>
</html>
